name: Run API Every Minute

on:
  schedule:
    - cron: '* * * * *'
  workflow_dispatch:

jobs:
  call-api:
    runs-on: ubuntu-latest
    steps:
      - name: Verify secret is loaded
        run: |
          if [ -z "$CRON_TOKEN" ]; then
            echo "‚ùå ERROR: CRON_TOKEN secret is empty or not loaded"
            exit 1
          else
            echo "‚úÖ CRON_TOKEN is loaded (length: ${#CRON_TOKEN} chars)"
          fi
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          
      - name: Call API with X-Cron-Token header
        run: |
          response=$(curl -s -w "\n%{http_code}" \
            -X GET \
            -H "X-Cron-Token: $CRON_TOKEN" \
            "https://networkcardahye.in/api/cron/run")
          
          http_code=$(echo "$response" | tail -n1)
          response_body=$(echo "$response" | head -n1)
          
          echo "üìä HTTP Status: $http_code"
          echo "üìù Response: $response_body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "üéâ SUCCESS: API call worked!"
          else
            echo "‚ùå FAILED: Check your token value"
            exit 1
          fi
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
